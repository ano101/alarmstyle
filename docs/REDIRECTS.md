# Система редиректов

Система управления редиректами позволяет настраивать переадресацию с одних URL на другие через административную панель Filament.

## Возможности

- **Гибкая настройка**: Указывайте любые пути для редиректа
- **Типы редиректов**: Поддержка 301 (постоянный) и 302 (временный) редиректов
- **Управление статусом**: Возможность активации/деактивации редиректов без удаления
- **Query string**: Автоматическая передача GET-параметров при редиректе
- **Уникальность**: Защита от дублирования исходных URL

## Использование

### Административная панель

1. Перейдите в раздел **Настройки → Редиректы** в панели Filament
2. Нажмите **Создать** для добавления нового редиректа
3. Заполните поля:
   - **Откуда (URL)**: Путь, с которого нужно сделать редирект (например: `/old-page`)
   - **Куда (URL)**: Путь или полный URL назначения (например: `/new-page` или `https://example.com`)
   - **Код ответа**: Выберите 301 (постоянный) или 302 (временный)
   - **Активен**: Включите/выключите редирект

### Примеры

```
Откуда: /old-catalog
Куда: /catalog
Код: 301
Активен: Да
```

При посещении `/old-catalog?page=2` пользователь будет перенаправлен на `/catalog?page=2` с кодом 301.

## Приоритет middleware

Редиректы обрабатываются **после** middleware `RedirectTrailingSlash`, который убирает trailing slash из URL.

Порядок выполнения:
1. `RedirectTrailingSlash` - убирает `/` в конце URL
2. `HandleRedirects` - проверяет и выполняет редиректы из БД
3. Остальные middleware

## База данных

### Таблица `redirects`

| Поле | Тип | Описание |
|------|-----|----------|
| id | bigint | ID редиректа |
| from_url | varchar | Исходный URL (уникальный) |
| to_url | varchar | URL назначения |
| status_code | int | Код HTTP ответа (301 или 302) |
| is_active | boolean | Активен ли редирект |
| created_at | timestamp | Дата создания |
| updated_at | timestamp | Дата обновления |

## Модель

### App\Models\Redirect

**Fillable поля:**
- `from_url`
- `to_url`
- `status_code`
- `is_active`

**Методы:**

```php
// Найти активный редирект по URL
Redirect::findActiveRedirect(string $url): ?Redirect
```

## Middleware

### App\Http\Middleware\HandleRedirects

Middleware проверяет каждый входящий запрос и выполняет редирект, если найден активный редирект для текущего пути.

**Логика работы:**
1. Получает путь запроса
2. Ищет активный редирект в базе данных
3. Если найден - выполняет редирект с сохранением query string
4. Если не найден - передает запрос дальше

## Тестирование

Тесты находятся в `tests/Feature/RedirectMiddlewareTest.php`

Запуск тестов:
```bash
vendor/bin/sail artisan test --filter=RedirectMiddlewareTest
```

## Рекомендации

1. **Используйте 301** для постоянных редиректов (изменение структуры сайта)
2. **Используйте 302** для временных редиректов (акции, временные страницы)
3. **Проверяйте циклы**: Убедитесь, что редирект не ведет сам на себя
4. **Активность**: Деактивируйте редиректы вместо удаления для возможности восстановления
5. **Мониторинг**: Периодически проверяйте актуальность настроенных редиректов
