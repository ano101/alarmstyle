<?php

namespace Database\Seeders;

use App\Models\Attribute;
use App\Models\AttributeGroup;
use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\DB;

class StarlineE7LteGpsAttributesSeeder extends Seeder
{
    public function run(): void
    {
        DB::transaction(function () {
            $groups = [
                'комплектация автосигнализации' => [
                    ['name' => 'центральный блок',               'value' => 'есть'],
                    ['name' => 'ЖК брелок',                      'value' => 'есть'],
                    ['name' => 'Дополнительный брелок',          'value' => 'нет'],
                    ['name' => 'брелок-метка',                   'value' => 'есть'],
                    ['name' => 'количество брелков-меток',      'value' => '1'],
                    ['name' => 'защитный чехол на брелок',       'value' => 'нет'],
                    ['name' => 'сирена',                         'value' => 'есть'],
                    ['name' => 'датчик удара и его тип',         'value' => 'есть'],
                    ['name' => 'датчик изменения объёма салона', 'value' => 'нет'],
                    ['name' => 'датчик перемещения/ускорения',   'value' => 'есть'],
                    ['name' => 'температурный датчик',           'value' => 'есть'],
                    ['name' => 'модуль автозапуска',             'value' => 'нет'],
                    ['name' => 'Микрофон',                       'value' => 'нет'],
                ],

                'охранные функции автосигнализации' => [
                    ['name' => 'персональный PIN-код аварийного отключения',          'value' => 'есть'],
                    ['name' => 'режим Valet',                                        'value' => 'есть'],
                    ['name' => 'режим Anti-Hi-Jack',                                 'value' => 'есть'],
                    ['name' => 'открытие только двери водителя при снятии с охраны', 'value' => 'нет'],
                    ['name' => 'охрана автомобиля с заведенным двигателем',          'value' => 'есть'],
                    ['name' => 'цифровое реле блокировки двигателя',                 'value' => 'нет'],
                ],

                'сервисные функции автосигнализации' => [
                    ['name' => 'функция "свободные руки"',              'value' => 'есть'],
                    ['name' => 'режим поиска автомобиля',               'value' => 'есть'],
                    ['name' => 'закрытие замков дверей по скорости',    'value' => 'есть'],
                    ['name' => 'бесшумное включение/выключение режима охраны', 'value' => 'есть'],
                ],

                'радиоканал и функции брелока' => [
                    ['name' => 'тип управляющего кода', 'value' => 'диалог'],
                    ['name' => 'контроль канала связи', 'value' => 'нет'],
                ],

                'автозапуск и турботаймер' => [
                    ['name' => 'дистанционный запуск двигателя',                          'value' => 'есть'],
                    ['name' => 'Поддержка автозапуска без обходчика*',                    'value' => 'есть'],
                    ['name' => 'режим "турботаймера"',                                    'value' => 'есть'],
                    ['name' => 'автоматический запуск двигателя через интервал (час)',    'value' => 'есть'],
                    ['name' => 'автоматический запуск двигателя по температуре в салоне (град.)',   'value' => 'есть'],
                    ['name' => 'автоматический запуск двигателя по температуре двигателя (град.)',  'value' => 'есть'],
                    ['name' => 'автоматический запуск двигателя по напряжению бортовой сети',       'value' => 'есть'],
                    ['name' => 'автоматический запуск двигателя по реальному времени',              'value' => 'есть'],
                ],

                'общие' => [
                    ['name' => 'рабочее напряжение питания',          'value' => '9-18'],
                    ['name' => 'страна изготовитель',                 'value' => 'Россия'],
                    ['name' => 'сайт фирмы-производителя',            'value' => 'starline.ru'],
                    ['name' => 'срок гарантии (мес.)',                'value' => '36'],
                    ['name' => 'интегрированный CAN-интерфейс',       'value' => 'есть'],
                    ['name' => 'интегрированный GSM-модуль',          'value' => 'есть'],
                    ['name' => 'управление штатным брелком Slave-режим', 'value' => 'есть'],
                    ['name' => 'Дальность действия (оповещение)',     'value' => 'в радиусе покрытия GSM'],
                    ['name' => 'работа с кнопкой запуска старт-стоп', 'value' => 'есть'],
                    ['name' => 'модуль управление замком капота',     'value' => 'опция'],
                    ['name' => 'Bluetooth интерфейс',                 'value' => 'есть'],
                ],

                'функции телематики' => [
                    ['name' => 'управление по GSM',   'value' => 'есть'],
                    ['name' => 'получение данных GPS','value' => 'опция'],
                ],
            ];

            foreach ($groups as $groupName => $attributes) {
                $group = AttributeGroup::firstOrCreate(['name' => $groupName]);

                $sort = 1;

                foreach ($attributes as $item) {
                    $attrName = $item['name'];
                    $rawValue = $item['value'];
                    $value    = trim($rawValue);

                    $isType1 = in_array(mb_strtolower($value), ['есть', 'нет', 'опция'], true);

                    // Не трогаем существующие атрибуты (type остаётся как был),
                    // тип ставим только при первом создании
                    $attribute = Attribute::firstOrCreate(
                        [
                            'attribute_group_id' => $group->id,
                            'name'               => $attrName,
                        ],
                        [
                            'type' => $isType1 ? 1 : 2,
                            'sort' => $sort++,
                        ]
                    );

                    // type=1 — значения создаст booted() в модели Attribute (Да/Нет/Опция)
                    if (! $isType1) {
                        $attribute->values()->firstOrCreate([
                            'value' => $value,
                        ]);
                    }
                }
            }
        });
    }
}
