<?php

namespace Database\Seeders;

use App\Models\Attribute;
use App\Models\AttributeGroup;
use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;

class AttributeSeeder extends Seeder
{
    public function run(): void
    {
        DB::transaction(function () {
            // Группы + атрибуты + значения из таблицы
            $groups = [
                'комплектация автосигнализации' => [
                    ['name' => 'центральный блок',                      'value' => 'есть'],
                    ['name' => 'ЖК брелок',                             'value' => 'есть'],
                    ['name' => 'Дополнительный брелок',                 'value' => 'нет'],
                    ['name' => 'брелок-метка',                          'value' => 'нет'],
                    ['name' => 'количество брелков-меток',             'value' => '0'],
                    ['name' => 'защитный чехол на брелок',              'value' => 'нет'],
                    ['name' => 'сирена',                                'value' => 'нет'],
                    ['name' => 'датчик удара и его тип',                'value' => 'встроенный'],
                    ['name' => 'датчик изменения объёма салона',        'value' => 'нет'],
                    ['name' => 'датчик перемещения/ускорения',          'value' => 'есть'],
                    ['name' => 'температурный датчик',                  'value' => 'нет'],
                    ['name' => 'модуль автозапуска',                    'value' => 'нет'],
                    ['name' => 'Микрофон',                              'value' => 'нет'],
                ],

                'охранные функции автосигнализации' => [
                    ['name' => 'персональный PIN-код аварийного отключения',           'value' => 'есть'],
                    ['name' => 'режим Valet',                                         'value' => 'есть'],
                    ['name' => 'режим Anti-Hi-Jack',                                  'value' => 'есть'],
                    ['name' => 'открытие только двери водителя при снятии с охраны',  'value' => 'есть'],
                    ['name' => 'охрана автомобиля с заведенным двигателем',           'value' => 'есть'],
                    ['name' => 'цифровое реле блокировки двигателя',                  'value' => 'опция'],
                ],

                'сервисные функции автосигнализации' => [
                    ['name' => 'функция "свободные руки"',                 'value' => 'нет'],
                    ['name' => 'режим поиска автомобиля',                  'value' => 'есть'],
                    ['name' => 'закрытие замков дверей по скорости',       'value' => 'есть'],
                    ['name' => 'бесшумное включение/выключение режима охраны', 'value' => 'есть'],
                ],

                'радиоканал и функции брелока' => [
                    ['name' => 'тип управляющего кода',                            'value' => 'диалоговый'],
                    ['name' => 'контроль канала связи',                            'value' => 'есть'],
                    ['name' => 'число кнопок брелка',                              'value' => '3'],
                    ['name' => 'вибро режим в брелке',                             'value' => 'есть'],
                    ['name' => 'режим напоминания о пропущенной тревоге на брелке', 'value' => 'есть'],
                    ['name' => 'часы в брелке',                                    'value' => 'есть'],
                    ['name' => 'подсветка ЖК-дисплея брелока',                     'value' => 'есть'],
                    ['name' => 'индикация напряжения аккумулятора автомобиля',     'value' => 'есть'],
                    ['name' => 'индикация температуры в салоне автомобиля',        'value' => 'есть'],
                    ['name' => 'индикация разряда батареи брелока',                'value' => 'есть'],
                ],

                'автозапуск и турботаймер' => [
                    ['name' => 'дистанционный запуск двигателя',                           'value' => 'опция'],
                    ['name' => 'Поддержка автозапуска без обходчика*',                     'value' => 'опция'],
                    ['name' => 'режим "турботаймера"',                                     'value' => 'опция'],
                    ['name' => 'автоматический запуск двигателя через интервал (час)',     'value' => 'опция'],
                    ['name' => 'автоматический запуск двигателя по температуре в салоне (град.)',   'value' => 'опция'],
                    ['name' => 'автоматический запуск двигателя по температуре двигателя (град.)', 'value' => 'опция'],
                    ['name' => 'автоматический запуск двигателя по напряжению бортовой сети',       'value' => 'опция'],
                    ['name' => 'автоматический запуск двигателя по реальному времени',              'value' => 'опция'],
                ],

                'общие' => [
                    ['name' => 'рабочее напряжение питания',      'value' => '12'],
                    ['name' => 'страна изготовитель',             'value' => 'Россия'],
                    ['name' => 'сайт фирмы-производителя',        'value' => 'alarmtrade.ru'],
                    ['name' => 'срок гарантии (мес.)',            'value' => '36'],
                    ['name' => 'интегрированный CAN-интерфейс',   'value' => 'есть'],
                    ['name' => 'интегрированный GSM-модуль',      'value' => 'нет'],
                    ['name' => 'управление штатным брелком Slave-режим', 'value' => 'есть'],
                    ['name' => 'работа с кнопкой запуска старт-стоп',    'value' => 'есть'],
                    ['name' => 'модуль управление замком капота',         'value' => 'опция'],
                    ['name' => 'Bluetooth интерфейс',                     'value' => 'нет'],
                ],

                'функции телематики' => [
                    ['name' => 'управление по GSM',   'value' => 'нет'],
                    ['name' => 'получение данных GPS', 'value' => 'нет'],
                ],
            ];

            foreach ($groups as $groupName => $attributes) {
                $group = AttributeGroup::firstOrCreate(['name' => Str::ucfirst($groupName)]);

                $sort = 1;

                foreach ($attributes as $item) {
                    $attrName = $item['name'];
                    $value = $item['value'];

                    // type = 1, если значение "есть / нет / опция"
                    $isType1 = in_array(mb_strtolower($value), ['есть', 'нет', 'опция'], true);

                    /** @var \App\Models\Attribute $attribute */
                    $attribute = Attribute::updateOrCreate(
                        [
                            'attribute_group_id' => $group->id,
                            'name' => Str::ucfirst($attrName),
                        ],
                        [
                            'type' => $isType1 ? 1 : 2,
                            'sort' => $sort++,
                        ]
                    );

                    // Для type=1 значения не создаём — их создаёт booted() в модели Attribute (Да/Нет/Опция)
                    if (! $isType1) {
                        // type=2 — одно значение из таблицы (12, Россия, 36, 0, 3, диалоговый, встроенный и т.п.)
                        $attribute->values()->firstOrCreate([
                            'value' => $value,
                        ]);
                    }
                }
            }
        });
    }
}
